<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Puxa Conversa</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }
        /* Estilo para bot√µes desabilitados que n√£o podem ser clicados */
        .filter-disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
            filter: grayscale(100%);
            border-color: #d1d5db; /* Cor cinza clara para o contorno */
            color: #d1d5db; /* Cor cinza clara para o texto */
            background-color: #f3f4f6; /* Fundo levemente cinza */
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen text-gray-800 p-4">
    <div class="flex flex-col lg:flex-row w-full max-w-7xl gap-6">
        <!-- Main Application Panel (Inclui Hist√≥rico no final para mobile) -->
        <div id="app-container" class="bg-white rounded-3xl shadow-xl p-8 w-full lg:w-2/3 flex flex-col items-center text-center transition-all duration-700 ease-in-out">
            <!-- Logo -->
            <img src="https://tamires-viana.github.io/apps/Logo%20Significativamente%20v2.png" alt="Logo da Significativamente" class="mb-6 h-12">
            
            <!-- T√≠tulo do aplicativo -->
            <h1 class="text-4xl font-bold mb-6 text-gray-800">Puxa Conversa</h1>

            <!-- Filtros -->
            <div class="w-full mb-6 text-gray-800">
                <h2 class="text-xl font-semibold mb-2">Origem</h2>
                <div id="origem-filter-container" class="flex flex-wrap justify-center gap-2 mb-4"></div>
                <h2 class="text-xl font-semibold mb-2">Tema</h2>
                <div id="tema-filter-container" class="flex flex-wrap justify-center gap-2 mb-4"></div>
            </div>

            <!-- Contagem de Perguntas -->
            <p id="question-count" class="text-lg font-medium text-gray-600 mb-4">0 perguntas dispon√≠veis.</p>

            <!-- Card da Pergunta -->
            <div id="question-card" class="bg-[#414141] rounded-2xl p-8 mb-8 w-full min-h-[200px] flex flex-col items-center justify-center shadow-lg transition-all duration-300 transform scale-100 text-white border border-gray-200">
                <p id="question-text" class="text-2xl font-medium leading-relaxed italic">
                    Clique no bot√£o para receber a primeira pergunta e come√ßar a conversa!
                </p>
                <div id="question-details" class="text-sm text-gray-200 mt-4 flex-col items-center hidden">
                    <p id="question-origin"></p>
                    <p id="question-themes"></p>
                </div>
            </div>

            <!-- Bot√£o para gerar a pr√≥xima pergunta -->
            <button id="next-question-btn" class="bg-[#9801fd] text-white font-bold py-3 px-8 rounded-full shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 mb-4">
                Surpreenda-me!
            </button>

            <!-- Bot√µes de Compartilhamento -->
            <div class="flex gap-4 mb-8">
                <button id="whatsapp-share-btn" class="bg-[#25D366] text-white font-bold py-2 px-6 rounded-full shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                    <span class="flex items-center gap-2">üí¨ WhatsApp</span>
                </button>
                <button id="share-btn" class="bg-black text-white font-bold py-2 px-6 rounded-full shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                    <span class="flex items-center gap-2">üîó Compartilhar</span>
                </button>
            </div>

            <!-- Painel do Hist√≥rico (Movemos para c√° para o mobile) -->
            <div id="history-panel-mobile" class="bg-gray-50 rounded-2xl shadow-inner p-6 w-full text-gray-800 lg:hidden block mt-4">
                <h2 class="text-xl font-bold mb-4 border-b pb-2 border-gray-200">Hist√≥rico</h2>
                <ul id="history-list-mobile" class="list-none p-0 space-y-4">
                    <!-- Perguntas do hist√≥rico ser√£o inseridas aqui -->
                </ul>
            </div>
        </div>
    
        <!-- Painel do Hist√≥rico (Vers√£o Desktop - Mantida na lateral) -->
        <div id="history-panel-desktop" class="bg-white rounded-3xl shadow-xl p-8 w-full lg:w-1/3 text-gray-800 hidden lg:block overflow-y-auto max-h-screen">
            <h2 class="text-xl font-bold mb-4">Hist√≥rico de Perguntas</h2>
            <ul id="history-list-desktop" class="list-none p-0 space-y-4">
                <!-- Perguntas do hist√≥rico ser√£o inseridas aqui -->
            </ul>
        </div>
    </div>

    <script>
        const csvFileUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTTA6rLAP6GbKi2fQI20XI1HYcSoNWalUHI-blYsORqXIG8hH5owmULSqeDT5iaJAhKjuwIl0i2Np0k/pub?output=csv';
        let allQuestions = [];
        let filteredQuestions = [];
        let activeFilters = { origem: new Set(), temas: new Set() };
        let questionHistory = [];
        const MAX_HISTORY_ITEMS = 5;

        // Mapeamento de emojis
        const emojiMap = {
            'Amor/Relacionamentos': '‚ù§Ô∏è',
            'Autoconhecimento': 'üß†',
            'Autoconhecimento/Valores': 'üß†',
            'Amizade': 'ü§ù',
            'Conex√£o Pessoal': 'üòä',
            'Mem√≥rias': 'üì∏',
            'Inf√¢ncia': 'üë∂',
            'Cotidiano/Leveza': '‚òï',
            'Reflex√£o sobre a vida': 'ü§î',
            'Passado': 'üï∞Ô∏è',
            'Curiosidade': 'üí°',
            'Sonhos': '‚ú®',
            'Legado': 'üëë',
            'Carreira': 'üíº',
            'Interesses': 'üåê',
            'Impacto': 'üí•',
            'Fam√≠lia': 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶',
            'Trabalho': 'üë∑',
            'Casais/Relacionamentos': 'üíë',
            'Crescimento Pessoal': 'üå±',
            'Emo√ß√µes': 'üé≠',
            'Medos': 'üëª',
            'Sociedade': 'üåé',
            'Vulnerabilidade': 'üõ°Ô∏è',
            'Resili√™ncia': 'üí™',
            'Valores': 'üíé',
            'Filosofia de Vida': 'üßò',
            'Coragem': 'ü¶Å',
            'Felicidade': 'üòä',
            'Consci√™ncia': 'üëÅÔ∏è',
            'Sucesso': 'üèÜ',
            'Aprendizado': 'üìñ',
            'Paz Interior': 'üïäÔ∏è',
            'Prop√≥sito': 'üß≠',
            'Solid√£o': 'üö∂',
            'Arrependimentos': 'üò•',
            'Perd√£o': 'üôè',
            'Lar': 'üè†',
            'Autocuidado': 'üõÄ',
            'Beleza': 'üíñ',
            'Tempo': '‚è≥',
            'Motiva√ß√£o': 'üöÄ',
            'Virtudes': 'üåü',
            'Futuro': 'üîÆ',
            'Surpresas': 'üéÅ',
            'Vida': 'üåø',
            'Liberdade': 'üóΩ',
            'For√ßa': 'üèãÔ∏è',
            'Alegria': 'üòÇ',
            'Tristeza': 'üò¢',
            'Fraquezas': 'ü©π',
            'Gratid√£o': 'üôå',
            'Mortalidade': 'üíÄ',
            'Luto': 'üñ§',
            'Esperan√ßa': '‚ú®',
            'Paix√µes': 'üî•',
            'Plenitude': 'üåà',
            'Conquistas': 'üèÖ',
            'Decis√µes': '‚öñÔ∏è',
            'Solid√£o': 'üö∂',
            'Divers√£o': 'üéâ',
            'Ambi√ß√£o': 'üöÄ',
            'Maturidade': 'üë¥',
            'Frustra√ß√£o': 'üò°',
            'Inspira√ß√£o': '‚ú®',
            'Gentileza': 'üå∏',
            'Raiva': 'üò†',
            'Inseguran√ßa': 'üòü',
            'Seguran√ßa': 'üîí',
            'Orgulho': 'ü§©',
            'Viagens/Futuro': '‚úàÔ∏è',
            'Humor': 'üòÇ',
            'Esportes': '‚öΩ',
            'Habilidades': 'üéØ',
            'Animais': 'üêæ',
            'Experi√™ncias Passadas': 'üó∫Ô∏è',
            'Cotidiano/Prefer√™ncias': 'üëç'
        };

        // Elementos da p√°gina
        const questionTextElement = document.getElementById('question-text');
        const nextQuestionBtn = document.getElementById('next-question-btn');
        const questionCard = document.getElementById('question-card');
        const questionCountElement = document.getElementById('question-count');
        const whatsappShareBtn = document.getElementById('whatsapp-share-btn');
        const shareBtn = document.getElementById('share-btn');
        const historyListDesktop = document.getElementById('history-list-desktop');
        const historyListMobile = document.getElementById('history-list-mobile');
        const questionDetailsElement = document.getElementById('question-details');
        const questionOriginElement = document.getElementById('question-origin');
        const questionThemesElement = document.getElementById('question-themes');
        const origemFilterContainer = document.getElementById('origem-filter-container');
        const temaFilterContainer = document.getElementById('tema-filter-container');

        // Fun√ß√£o para parsear o CSV (mantida robusta)
        function parseCSV(csv) {
            const data = [];
            const lines = csv.split(/\r?\n/).filter(line => line.trim() !== '');

            lines.forEach((line, index) => {
                if (index === 0) return; // Pular o cabe√ßalho

                const row = [];
                let inQuote = false;
                let field = '';

                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        if (inQuote && line[i + 1] === '"') {
                            field += '"';
                            i++;
                        } else {
                            inQuote = !inQuote;
                        }
                    } else if (char === ',' && !inQuote) {
                        row.push(field);
                        field = '';
                    } else {
                        field += char;
                    }
                }
                row.push(field);
                
                if (row.length >= 3) {
                    data.push({
                        origem: row[0].trim(),
                        pergunta: row[1].trim(),
                        temas: row[2].trim()
                    });
                }
            });
            return data;
        }

        // Fun√ß√£o utilit√°ria para obter valores √∫nicos de um campo (incluindo subtemas)
        function getUniqueValues(data, key) {
            const uniqueValues = new Set();
            data.forEach(item => {
                if (item[key]) {
                    item[key].split(',').forEach(value => uniqueValues.add(value.trim()));
                }
            });
            return ['Todos', ...Array.from(uniqueValues).sort()];
        }

        // Fun√ß√£o de estilo de bot√£o
        function setButtonActive(button, isActive) {
            if (isActive) {
                button.classList.remove('bg-white', 'text-gray-800', 'filter-disabled');
                button.classList.add('bg-[#9801fd]', 'text-white');
            } else {
                button.classList.remove('bg-[#9801fd]', 'text-white', 'filter-disabled');
                button.classList.add('bg-white', 'text-gray-800');
            }
        }

        // --- L√ìGICA DE FILTROS CRUZADOS ---

        function getAvailableFilterValues(keyToFilter, otherFilterKey) {
            let availableValues = new Set();
            
            // 1. Determine o conjunto de perguntas que satisfazem o OUTRO filtro
            let currentFilteredSet = allQuestions;
            if (activeFilters[otherFilterKey].size > 0) {
                currentFilteredSet = allQuestions.filter(q => {
                    const filterValues = q[otherFilterKey].split(',').map(v => v.trim());
                    // Verifica se pelo menos um valor do filtro ativo est√° presente na pergunta
                    return Array.from(activeFilters[otherFilterKey]).some(activeVal => filterValues.includes(activeVal));
                });
            }

            // 2. Coleta todos os valores do 'keyToFilter' dessas perguntas
            currentFilteredSet.forEach(item => {
                item[keyToFilter].split(',').forEach(value => availableValues.add(value.trim()));
            });

            return availableValues;
        }

        function updateFilterInteractivity() {
            // Atualiza os bot√µes de Tema com base nas Origens ativas
            const availableTemas = getAvailableFilterValues('temas', 'origem');
            temaFilterContainer.querySelectorAll('button').forEach(button => {
                const value = button.textContent;
                
                if (value === 'Todos') return;

                if (availableTemas.has(value)) {
                    button.classList.remove('filter-disabled');
                    if (!activeFilters.temas.has(value)) {
                        setButtonActive(button, false);
                    }
                } else {
                    // Desabilita e desmarca se n√£o for mais relevante
                    button.classList.add('filter-disabled');
                    if (activeFilters.temas.has(value)) {
                        activeFilters.temas.delete(value);
                        setButtonActive(button, false);
                    }
                }
            });
            
            // Atualiza os bot√µes de Origem com base nos Temas ativos
            const availableOrigens = getAvailableFilterValues('origem', 'temas');
            origemFilterContainer.querySelectorAll('button').forEach(button => {
                const value = button.textContent;
                
                if (value === 'Todos') return;

                if (availableOrigens.has(value)) {
                    button.classList.remove('filter-disabled');
                    if (!activeFilters.origem.has(value)) {
                        setButtonActive(button, false);
                    }
                } else {
                    // Desabilita e desmarca se n√£o for mais relevante
                    button.classList.add('filter-disabled');
                    if (activeFilters.origem.has(value)) {
                        activeFilters.origem.delete(value);
                        setButtonActive(button, false);
                    }
                }
            });
            
            // Reativa o bot√£o 'Todos' se todos os outros estiverem desabilitados ou nenhum filtro estiver ativo
            const allTemasDisabled = Array.from(temaFilterContainer.querySelectorAll('button')).slice(1).every(btn => btn.classList.contains('filter-disabled'));
            const allOrigensDisabled = Array.from(origemFilterContainer.querySelectorAll('button')).slice(1).every(btn => btn.classList.contains('filter-disabled'));
            
            if (activeFilters.origem.size === 0 || allOrigensDisabled) {
                setButtonActive(origemFilterContainer.querySelector('button'), true);
            }
             if (activeFilters.temas.size === 0 || allTemasDisabled) {
                setButtonActive(temaFilterContainer.querySelector('button'), true);
            }
        }

        // Cria√ß√£o de Bot√µes de Filtro
        function createFilterButtons(containerId, data, key) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            let values = getUniqueValues(data, key);

            values.forEach(filterValue => {
                const button = document.createElement('button');
                button.textContent = filterValue;
                
                // Estilo padr√£o
                button.classList.add('px-4', 'py-2', 'rounded-full', 'border-2', 'border-[#9801fd]', 'bg-white', 'text-gray-800', 'font-semibold', 'text-sm', 'hover:bg-gray-100', 'transition-colors', 'duration-200', 'whitespace-nowrap');

                // Garante que o bot√£o "Todos" comece ativo
                if (filterValue === 'Todos') {
                    setButtonActive(button, true);
                }

                button.addEventListener('click', () => {
                    const isTodosButton = filterValue === 'Todos';
                    
                    if (isTodosButton) {
                        // Desseleciona todos os outros e seleciona "Todos"
                        activeFilters[key].clear();
                        container.querySelectorAll('button').forEach(btn => setButtonActive(btn, false));
                        setButtonActive(button, true);
                    } else {
                        // Desseleciona "Todos" e gerencia o estado do bot√£o clicado
                        const todosButton = container.querySelector('button');
                        if (todosButton && todosButton.textContent === 'Todos') {
                            setButtonActive(todosButton, false);
                        }

                        if (activeFilters[key].has(filterValue)) {
                            activeFilters[key].delete(filterValue);
                            setButtonActive(button, false);
                        } else {
                            activeFilters[key].add(filterValue);
                            setButtonActive(button, true);
                        }
                    }
                    
                    // Se nenhum filtro individual estiver ativo, reativa o 'Todos'
                    if (activeFilters[key].size === 0 && !isTodosButton) {
                        setButtonActive(container.querySelector('button'), true);
                    }
                    
                    // Aplica e atualiza a interatividade
                    applyFilter();
                    updateFilterInteractivity();
                });
                container.appendChild(button);
            });
        }


        // Aplica√ß√£o e Contagem
        function applyFilter() {
            filteredQuestions = allQuestions.filter(q => {
                // Filtro 1: Origem (Coluna A)
                const isOrigemMatch = activeFilters.origem.size === 0 || Array.from(activeFilters.origem).some(activeVal => activeVal === q.origem);
                
                // Filtro 2: Temas (Coluna C, que pode ter m√∫ltiplos valores separados por v√≠rgula)
                const isTemasMatch = activeFilters.temas.size === 0 || q.temas.split(',').some(theme => Array.from(activeFilters.temas).includes(theme.trim()));
                
                return isOrigemMatch && isTemasMatch;
            });
            updateQuestionCount();
        }

        function updateQuestionCount() {
            const count = filteredQuestions.length;
            const text = count === 1 ? 'pergunta dispon√≠vel.' : 'perguntas dispon√≠veis.';
            questionCountElement.textContent = `${count} ${text}`;
            if (count === 0) {
                questionTextElement.textContent = "Nenhuma pergunta encontrada para os filtros selecionados.";
                questionDetailsElement.classList.add('hidden');
            }
        }
        
        // Hist√≥rico
        function updateHistory(questionData) {
            if (questionHistory.length >= MAX_HISTORY_ITEMS) {
                questionHistory.shift(); 
            }
            questionHistory.push(questionData);
            renderHistory();
        }
        
        function renderHistory() {
            // Limpa ambos os pain√©is (desktop e mobile)
            historyListDesktop.innerHTML = '';
            historyListMobile.innerHTML = '';

            const reversedHistory = questionHistory.slice().reverse();

            reversedHistory.forEach(q => {
                const li = document.createElement('li');
                li.className = 'border-l-4 border-[#9801fd] pl-4 py-2 text-sm text-gray-700';
                
                const originEl = document.createElement('p');
                originEl.className = 'font-bold text-[#9801fd]';
                originEl.textContent = `Origem: ${q.origem}`;

                const temasEl = document.createElement('p');
                temasEl.className = 'text-gray-500 italic mb-1';
                temasEl.textContent = `Temas: ${q.temas}`;

                const questionEl = document.createElement('p');
                
                // Adiciona emoji ao hist√≥rico
                const themesArray = q.temas.split(',').map(t => t.trim());
                let emoji = themesArray.map(t => emojiMap[t]).find(e => e) || '';
                questionEl.textContent = `${emoji} ${q.pergunta}`;

                // Ordem no Hist√≥rico: Origem > Tema > Pergunta
                li.appendChild(originEl);
                li.appendChild(temasEl);
                li.appendChild(questionEl);
                
                // Clona para ambos os layouts
                historyListDesktop.appendChild(li.cloneNode(true));
                historyListMobile.appendChild(li);
            });
        }

        // Inicializa√ß√£o
        async function loadAndInitialize() {
            try {
                const response = await fetch(csvFileUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvContent = await response.text();
                allQuestions = parseCSV(csvContent);
                
                // Cria os bot√µes e inicializa os filtros
                createFilterButtons('origem-filter-container', allQuestions, 'origem');
                createFilterButtons('tema-filter-container', allQuestions, 'temas');
                
                // O filtro inicial √© sempre 'Todos', mas aplicamos aqui para atualizar contagem
                applyFilter();
                updateFilterInteractivity(); // Garante que a interatividade inicial esteja correta
            } catch (error) {
                console.error("Erro ao carregar o arquivo CSV:", error);
                questionTextElement.textContent = "Erro ao carregar as perguntas. Por favor, verifique se o link do CSV est√° correto.";
            }
        }
        
        // Event Listeners
        nextQuestionBtn.addEventListener('click', () => {
            if (filteredQuestions.length > 0) {
                const randomIndex = Math.floor(Math.random() * filteredQuestions.length);
                const questionData = filteredQuestions[randomIndex];
                const themesArray = questionData.temas.split(',').map(t => t.trim());
                let emoji = themesArray.map(t => emojiMap[t]).find(e => e) || '';
                const randomQuestion = `${emoji} ${questionData.pergunta}`;
                
                // Efeito visual de transi√ß√£o
                questionCard.classList.add('opacity-0', 'scale-95');
                
                setTimeout(() => {
                    questionTextElement.textContent = randomQuestion;
                    questionOriginElement.textContent = `Origem: ${questionData.origem}`;
                    questionThemesElement.textContent = `Temas: ${questionData.temas}`;
                    questionDetailsElement.classList.remove('hidden');
                    questionDetailsElement.classList.add('flex');
                    questionCard.classList.remove('opacity-0', 'scale-95');
                }, 300);
                
                updateHistory(questionData);

            } else {
                questionTextElement.textContent = "Nenhuma pergunta encontrada para os filtros selecionados.";
                questionDetailsElement.classList.add('hidden');
            }
        });

        // Compartilhamento
        function handleShare() {
            const textToShare = questionTextElement.textContent;
            const shareText = `Olha que legal essa pergunta: ${textToShare}`;
            
            if (textToShare && textToShare !== "Clique no bot√£o para receber a primeira pergunta e come√ßar a conversa!" && textToShare !== "Nenhuma pergunta encontrada para os filtros selecionados.") {
                return shareText;
            }
            return null;
        }

        whatsappShareBtn.addEventListener('click', () => {
            const shareText = handleShare();
            if (shareText) {
                const whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(shareText)}`;
                window.open(whatsappUrl, '_blank');
            }
        });

        shareBtn.addEventListener('click', () => {
            const shareText = handleShare();
            if (shareText) {
                if (navigator.share) {
                    navigator.share({
                        title: 'Puxa Conversa',
                        text: shareText
                    }).catch(error => console.log('Erro ao compartilhar', error));
                } else if (navigator.clipboard) {
                    navigator.clipboard.writeText(shareText).then(() => {
                        const msgBox = document.createElement('div');
                        msgBox.textContent = 'Pergunta copiada para a √°rea de transfer√™ncia! Cole onde desejar, como nos Stories do Instagram.';
                        msgBox.style.cssText = `
                            position: fixed;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%);
                            background-color: #333;
                            color: white;
                            padding: 20px;
                            border-radius: 10px;
                            z-index: 1000;
                            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                        `;
                        document.body.appendChild(msgBox);
                        setTimeout(() => document.body.removeChild(msgBox), 3000);
                    }).catch(err => {
                        console.error('Erro ao copiar texto: ', err);
                    });
                }
            }
        });

        loadAndInitialize();
    </script>
</body>
</html>
