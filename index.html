<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Puxa Conversa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            transition: background-image 1s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen text-gray-800 p-4">
    <div id="app-container" class="bg-white rounded-3xl shadow-xl p-8 max-w-4xl w-full flex flex-col items-center text-center text-white transition-all duration-700 ease-in-out">
        <!-- T√≠tulo do aplicativo -->
        <h1 class="text-4xl font-bold mb-6 text-gray-800">Puxa Conversa</h1>

        <!-- Filtros -->
        <div class="w-full mb-6">
            <h2 class="text-xl font-semibold mb-2 text-gray-800">Origem</h2>
            <div id="origem-filter-container" class="flex flex-wrap justify-center gap-2 mb-4"></div>
            <h2 class="text-xl font-semibold mb-2 text-gray-800">Tema</h2>
            <div id="tema-filter-container" class="flex flex-wrap justify-center gap-2 mb-4"></div>
        </div>

        <!-- Contagem de Perguntas -->
        <p id="question-count" class="text-lg font-medium text-gray-600 mb-4">0 perguntas dispon√≠veis.</p>

        <!-- Card da Pergunta -->
        <div id="question-card" class="bg-white/90 backdrop-blur-sm rounded-2xl p-8 mb-8 w-full min-h-[200px] flex flex-col items-center justify-center shadow-lg transition-all duration-300 transform scale-100 text-gray-800 border border-gray-200">
            <p id="question-text" class="text-2xl font-medium leading-relaxed italic">
                Clique no bot√£o para receber a primeira pergunta e come√ßar a conversa!
            </p>
        </div>

        <!-- Bot√£o para gerar a pr√≥xima pergunta -->
        <button id="next-question-btn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 mb-4">
            Pr√≥xima Pergunta
        </button>

        <!-- Bot√µes de Compartilhamento -->
        <div class="flex gap-4">
            <button id="whatsapp-share-btn" class="bg-green-500 text-white font-bold py-2 px-6 rounded-full shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                <span class="flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946l.003-.018c.001-4.832 3.844-8.761 8.675-8.761h.004c2.815 0 5.405 1.109 7.35 3.064 1.945 1.954 3.044 4.544 3.041 7.356v.003c-.001 4.832-3.931 8.76-8.763 8.761-1.928.001-3.827-.686-5.385-2.062l-6.223 1.623zm1.614-5.266l-.001.005-.187-.052-1.282.336 1.349-4.912c.983.565 2.102.88 3.253.882h.001l.004-.002c4.114 0 7.464-3.356 7.462-7.47v-.002c-.001-2.049-.806-3.968-2.259-5.424-1.45-1.455-3.37-2.261-5.424-2.262h-.001c-4.116 0-7.466 3.356-7.466 7.47.001 2.052.808 3.968 2.26 5.424l.001-.001.002.001z"/>
                    </svg>
                    WhatsApp
                </span>
            </button>
            <button id="share-btn" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-full shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                <span class="flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.16.09-.32.09-.49s-.04-.33-.09-.49l7.05-4.11c.52.48 1.2.77 1.96.77 1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2c0 .17.04.33.09.49L7.96 9.83C7.44 9.35 6.76 9.05 6 9.05c-1.1 0-2 .9-2 2s.9 2 2 2c.76 0 1.44-.3 1.96-.77l7.05 4.11c-.05.16-.09.32-.09.49s.04.33.09.49l-7.05-4.11c-.52.48-1.2-.77-1.96-.77-1.1 0-2 .9-2 2s.9 2 2 2c0-.17-.04-.33-.09-.49l7.05-4.11c.52.48 1.2.77 1.96.77 1.1 0 2-.9 2-2s-.9-2-2-2z"/>
                    </svg>
                    Compartilhar
                </span>
            </button>
        </div>
    </div>

    <script>
        // INSTRU√á√ïES:
        // 1. Abra a sua planilha do Google Sheets.
        // 2. Copie o ID da planilha que est√° na URL, entre "/d/" e "/edit".
        // 3. Substitua o "SEU_ID_DA_PLANILHA_AQUI" abaixo por esse ID.
        // O link de download direto garantir√° que o aplicativo leia o conte√∫do do CSV.
        const spreadsheetId = '18tDk6CJVF6zEQxd9BoXoVh3AQL29J8ElPzMAXhdIOc8';
        const csvFileUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/export?format=csv`;

        let allQuestions = [];
        let filteredQuestions = [];
        let activeFilters = { origem: new Set(), temas: new Set() };
        
        const colorGradients = [
            'linear-gradient(to right bottom, #3b82f6, #60a5fa, #93c5fd, #bfdbfe)',
            'linear-gradient(to right bottom, #10b981, #34d399, #6ee7b7, #a7f3d0)',
            'linear-gradient(to right bottom, #ef4444, #f87171, #fca5a5, #fecaca)',
            'linear-gradient(to right bottom, #f59e0b, #fbbf24, #fcd34d, #fde68a)',
            'linear-gradient(to right bottom, #8b5cf6, #a78bfa, #c4b5fd, #ddd6fe)'
        ];

        const emojiMap = {
            'Amor/Relacionamentos': '‚ù§Ô∏è',
            'Autoconhecimento': 'üß†',
            'Autoconhecimento/Valores': 'üß†',
            'Amizade': 'ü§ù',
            'Conex√£o Pessoal': 'üòä',
            'Mem√≥rias': 'üì∏',
            'Inf√¢ncia': 'üë∂',
            'Cotidiano/Leveza': '‚òï',
            'Reflex√£o sobre a vida': 'ü§î',
            'Passado': 'üï∞Ô∏è',
            'Curiosidade': 'üí°',
            'Sonhos': '‚ú®',
            'Legado': 'üëë',
            'Carreira': 'üíº',
            'Interesses': 'üåê',
            'Impacto': 'üí•',
            'Fam√≠lia': 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶',
            'Trabalho': 'üë∑',
            'Casais/Relacionamentos': 'üíë',
            'Crescimento Pessoal': 'üå±',
            'Emo√ß√µes': 'üé≠',
            'Medos': 'üëª',
            'Sociedade': 'üåé',
            'Vulnerabilidade': 'üõ°Ô∏è',
            'Resili√™ncia': 'üí™',
            'Valores': 'üíé',
            'Filosofia de Vida': 'üßò',
            'Coragem': 'ü¶Å',
            'Felicidade': 'üòä',
            'Consci√™ncia': 'üëÅÔ∏è',
            'Sucesso': 'üèÜ',
            'Aprendizado': 'üìñ',
            'Paz Interior': 'üïäÔ∏è',
            'Prop√≥sito': 'üß≠',
            'Solid√£o': 'üö∂',
            'Arrependimentos': 'üò•',
            'Perd√£o': 'üôè',
            'Lar': 'üè†',
            'Autocuidado': 'üõÄ',
            'Beleza': 'üíñ',
            'Tempo': '‚è≥',
            'Motiva√ß√£o': 'üöÄ',
            'Virtudes': 'üåü',
            'Futuro': 'üîÆ',
            'Surpresas': 'üéÅ',
            'Vida': 'üåø',
            'Liberdade': 'üóΩ',
            'For√ßa': 'üèãÔ∏è',
            'Alegria': 'üòÇ',
            'Tristeza': 'üò¢',
            'Fraquezas': 'ü©π',
            'Gratid√£o': 'üôå',
            'Mortalidade': 'üíÄ',
            'Luto': 'üñ§',
            'Esperan√ßa': '‚ú®',
            'Paix√µes': 'üî•',
            'Plenitude': 'üåà',
            'Conquistas': 'üèÖ',
            'Decis√µes': '‚öñÔ∏è',
            'Solid√£o': 'üö∂',
            'Divers√£o': 'üéâ',
            'Ambi√ß√£o': 'üöÄ',
            'Maturidade': 'üë¥',
            'Frustra√ß√£o': 'üò°',
            'Inspira√ß√£o': '‚ú®',
            'Gentileza': 'üå∏',
            'Raiva': 'üò†',
            'Inseguran√ßa': 'üòü',
            'Seguran√ßa': 'üîí',
            'Orgulho': 'ü§©',
            'Viagens/Futuro': '‚úàÔ∏è',
            'Humor': 'üòÇ',
            'Esportes': '‚öΩ',
            'Habilidades': 'üéØ',
            'Animais': 'üêæ',
            'Experi√™ncias Passadas': 'üó∫Ô∏è',
            'Cotidiano/Prefer√™ncias': 'üëç'
        };

        let lastColorIndex = -1;

        // Elementos da p√°gina
        const questionTextElement = document.getElementById('question-text');
        const nextQuestionBtn = document.getElementById('next-question-btn');
        const questionCard = document.getElementById('question-card');
        const questionCountElement = document.getElementById('question-count');
        const whatsappShareBtn = document.getElementById('whatsapp-share-btn');
        const shareBtn = document.getElementById('share-btn');

        // Fun√ß√£o para parsear o CSV e extrair as perguntas e metadados
        function parseCSV(csv) {
            const data = [];
            const lines = csv.split(/\r?\n/).filter(line => line.trim() !== '');

            // Regex para capturar campos, incluindo aqueles entre aspas
            const regex = /"([^"]*)"|([^,]*)/g;

            lines.forEach((line, index) => {
                if (index === 0) return; // Pular o cabe√ßalho
                
                let match;
                const row = [];
                while ((match = regex.exec(line)) !== null) {
                    // O primeiro grupo de captura (match[1]) √© para o texto entre aspas.
                    // O segundo grupo (match[2]) √© para o texto sem aspas.
                    const value = match[1] || match[2];
                    if (value !== undefined && value.trim() !== '') {
                        row.push(value.trim());
                    }
                }

                if (row.length >= 3) {
                    data.push({
                        origem: row[0],
                        pergunta: row[1],
                        temas: row[2]
                    });
                } else {
                    console.warn(`Linha inv√°lida (pular): ${line}`);
                }
            });
            return data;
        }

        function getUniqueValues(data, key) {
            const uniqueValues = new Set();
            data.forEach(item => {
                if (item[key]) {
                    item[key].split(',').forEach(value => uniqueValues.add(value.trim()));
                }
            });
            return ['Todos', ...Array.from(uniqueValues).sort()];
        }

        function createFilterButtons(containerId, data, key) {
            const container = document.getElementById(containerId);
            container.innerHTML = ''; // Limpa bot√µes antigos
            let values = getUniqueValues(data, key);

            values.forEach(filterValue => {
                const button = document.createElement('button');
                button.textContent = filterValue;
                button.classList.add('px-4', 'py-2', 'rounded-full', 'bg-white', 'text-blue-600', 'font-semibold', 'text-sm', 'hover:bg-blue-100', 'transition-colors', 'duration-200', 'whitespace-nowrap');

                button.addEventListener('click', () => {
                    if (filterValue === 'Todos') {
                        activeFilters[key].clear();
                        container.querySelectorAll('button').forEach(btn => btn.classList.remove('border-2', 'border-blue-600', 'bg-blue-600', 'text-white'));
                        button.classList.add('border-2', 'border-blue-600', 'bg-blue-600', 'text-white');
                    } else {
                        const todosButton = container.querySelector('button');
                        if (todosButton && todosButton.textContent === 'Todos') {
                            todosButton.classList.remove('border-2', 'border-blue-600', 'bg-blue-600', 'text-white');
                        }

                        if (activeFilters[key].has(filterValue)) {
                            activeFilters[key].delete(filterValue);
                            button.classList.remove('border-2', 'border-blue-600', 'bg-blue-600', 'text-white');
                        } else {
                            activeFilters[key].add(filterValue);
                            button.classList.add('border-2', 'border-blue-600', 'bg-blue-600', 'text-white');
                        }
                    }
                    applyFilter();
                });
                container.appendChild(button);
            });
            // Ativa o bot√£o 'Todos' por padr√£o
            container.querySelector('button').classList.add('border-2', 'border-blue-600', 'bg-blue-600', 'text-white');
        }

        function applyFilter() {
            filteredQuestions = allQuestions.filter(q => {
                const isOrigemMatch = activeFilters.origem.size === 0 || activeFilters.origem.has(q.origem);
                const isTemasMatch = activeFilters.temas.size === 0 || q.temas.split(',').some(theme => activeFilters.temas.has(theme.trim()));
                return isOrigemMatch && isTemasMatch;
            });
            updateQuestionCount();
        }

        function updateQuestionCount() {
            const count = filteredQuestions.length;
            questionCountElement.textContent = `${count} pergunta${count !== 1 ? 's' : ''} dispon√≠vel${count !== 1 ? 'is' : ''}.`;
            if (count === 0) {
                questionTextElement.textContent = "Nenhuma pergunta encontrada para os filtros selecionados.";
            }
        }

        function changeBackgroundColor() {
            let newColorIndex;
            do {
                newColorIndex = Math.floor(Math.random() * colorGradients.length);
            } while (newColorIndex === lastColorIndex);
            
            lastColorIndex = newColorIndex;
            const appContainer = document.getElementById('app-container');
            appContainer.style.backgroundImage = colorGradients[newColorIndex];
        }

        async function loadAndInitialize() {
            try {
                const response = await fetch(csvFileUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvContent = await response.text();
                allQuestions = parseCSV(csvContent);
                console.log('Perguntas carregadas:', allQuestions.length);
                createFilterButtons('origem-filter-container', allQuestions, 'origem');
                createFilterButtons('tema-filter-container', allQuestions, 'temas');
                applyFilter();
                changeBackgroundColor();
                console.log("Aplicativo inicializado com sucesso.");
            } catch (error) {
                console.error("Erro ao carregar o arquivo CSV:", error);
                questionTextElement.textContent = "Erro ao carregar as perguntas. Por favor, verifique se o link do CSV est√° correto.";
            }
        }
        
        // Adicionar o evento de clique ao bot√£o de pr√≥xima pergunta
        nextQuestionBtn.addEventListener('click', () => {
            if (filteredQuestions.length > 0) {
                const randomIndex = Math.floor(Math.random() * filteredQuestions.length);
                const questionData = filteredQuestions[randomIndex];
                // Find a matching emoji based on the themes
                const themesArray = questionData.temas.split(',').map(t => t.trim());
                let emoji = themesArray.map(t => emojiMap[t]).find(e => e) || '';
                const randomQuestion = `${emoji} ${questionData.pergunta}`;
                
                // Adiciona classes para anima√ß√£o de sa√≠da
                questionCard.classList.add('opacity-0', 'scale-95');
                
                setTimeout(() => {
                    questionTextElement.textContent = randomQuestion;
                    // Remove as classes para anima√ß√£o de entrada
                    questionCard.classList.remove('opacity-0', 'scale-95');
                }, 300);
                
                changeBackgroundColor();

            } else {
                questionTextElement.textContent = "Nenhuma pergunta encontrada para os filtros selecionados.";
            }
        });

        // Adicionar eventos de clique aos bot√µes de compartilhamento
        whatsappShareBtn.addEventListener('click', () => {
            const text = questionTextElement.textContent;
            if (text && text !== "Clique no bot√£o para receber a primeira pergunta e come√ßar a conversa!" && text !== "Nenhuma pergunta encontrada para os filtros selecionados.") {
                const whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(text)}`;
                window.open(whatsappUrl, '_blank');
            }
        });

        shareBtn.addEventListener('click', () => {
            const textToShare = questionTextElement.textContent;
            if (textToShare && textToShare !== "Clique no bot√£o para receber a primeira pergunta e come√ßar a conversa!" && textToShare !== "Nenhuma pergunta encontrada para os filtros selecionados.") {
                if (navigator.share) {
                    navigator.share({
                        title: 'Puxa Conversa',
                        text: textToShare
                    }).catch(error => console.log('Erro ao compartilhar', error));
                } else if (navigator.clipboard) {
                    navigator.clipboard.writeText(textToShare).then(() => {
                        // Use a custom message box instead of alert
                        const msgBox = document.createElement('div');
                        msgBox.textContent = 'Pergunta copiada para a √°rea de transfer√™ncia! Cole onde desejar, como nos Stories do Instagram.';
                        msgBox.style.cssText = `
                            position: fixed;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%);
                            background-color: #333;
                            color: white;
                            padding: 20px;
                            border-radius: 10px;
                            z-index: 1000;
                            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                        `;
                        document.body.appendChild(msgBox);
                        setTimeout(() => document.body.removeChild(msgBox), 3000);
                    }).catch(err => {
                        console.error('Erro ao copiar texto: ', err);
                    });
                } else {
                    // Use a custom message box instead of alert
                    const msgBox = document.createElement('div');
                    msgBox.textContent = 'Seu navegador n√£o suporta o compartilhamento autom√°tico. Por favor, copie e cole a pergunta manualmente.';
                    msgBox.style.cssText = `
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background-color: #333;
                        color: white;
                        padding: 20px;
                        border-radius: 10px;
                        z-index: 1000;
                        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                    `;
                    document.body.appendChild(msgBox);
                    setTimeout(() => document.body.removeChild(msgBox), 3000);
                }
            }
        });

        // Inicia o carregamento dos dados e a inicializa√ß√£o da aplica√ß√£o
        loadAndInitialize();
    </script>
</body>
</html>
